---
description: Prompt generation design. XML structure, tag naming, instruction wording, token efficiency, escaping, ordering, and how to write effective descriptions.
---

# Prompt Generation

The SessionStart hook outputs XML that Claude Code injects into the session context. This doc explains the design decisions behind that prompt -- why it's structured the way it is and how to write descriptions that work well with it.

## Prompt Structure

The output has three sections inside a `<microdoc>` root:

```xml
<microdoc>
<attribution>Injected by microdoc (by Rafael Kallis) from project documentation files.</attribution>
<instructions>
Project documentation is available as markdown files with YAML frontmatter descriptions.
Consult relevant docs before making architectural suggestions or implementation decisions.
When a doc's description overlaps with the current task, use Read to load its full content before proceeding.
</instructions>

<docs>
<doc>
<path>docs/example.md</path>
<description>Description text here</description>
</doc>
</docs>
</microdoc>
```

- **`<attribution>`** -- identifies the source. Signals to Claude that this block was machine-generated by a plugin, not authored by the user. This helps Claude calibrate trust and avoids confusing injected context with user instructions.
- **`<instructions>`** -- three sentences that tell Claude how to use the docs (see below).
- **`<docs>`** -- the doc index. One `<doc>` entry per matched file, each with a path and description.

## Tag Naming

**`<microdoc>` as root** -- a unique, unambiguous tag name. Generic names like `<context>` or `<docs>` risk colliding with other plugins or system-level tags. The plugin name doubles as a namespace.

**`<doc>` not `<file>`** -- these are documentation entries, not arbitrary files. `<doc>` communicates intent: Claude should treat these as reference material to consult, not source code to modify.

**`<path>` + `<description>` as children** -- flat, semantic tags. The path tells Claude where to find the file (for the Read tool). The description tells Claude what's inside without reading it. No nesting beyond this -- complexity would waste tokens for no benefit.

## Instructions Text

Three sentences, each with a specific job:

1. **"Project documentation is available as markdown files with YAML frontmatter descriptions."** -- Orients Claude to what this block contains. Without this, Claude might not understand the relationship between the descriptions and the files.

2. **"Consult relevant docs before making architectural suggestions or implementation decisions."** -- Establishes a behavioral norm: check docs first. This prevents Claude from ignoring the index and making suggestions that contradict documented decisions.

3. **"When a doc's description overlaps with the current task, use Read to load its full content before proceeding."** -- The critical trigger. Descriptions are summaries, not substitutes. This sentence tells Claude to use Read when a description matches, completing the lightweight RAG loop.

## Token Efficiency

The core design principle: descriptions serve as an **index**, not a cache.

Injecting full doc content would blow up the context window. A 10-doc project with 200 lines per doc would consume thousands of tokens on every session, most of it irrelevant to the current task.

Instead, microdoc injects only the path and a short description (~15-20 words). Claude scans the index, identifies relevant docs, and reads them on demand. This keeps the injected prompt small (typically under 500 tokens for 10 docs) while giving Claude access to arbitrarily large documentation.

**The `(no description)` fallback** -- files without a frontmatter description still appear in the index with `(no description)`. This ensures Claude knows the file exists even when the description is missing, though it can't judge relevance without one. A doc with no description is less likely to be read when relevant -- another reason to always write descriptions.

## XML Escaping

Three characters are escaped in descriptions via `xmlEscape`:

- `&` to `&amp;`
- `<` to `&lt;`
- `>` to `&gt;`

This prevents two problems:

1. **Malformed XML** -- an unescaped `<` in a description would break the tag structure, potentially causing Claude to misparse the entire block.
2. **Prompt injection** -- a description containing raw `<instructions>` or similar tags could inject arbitrary instructions into the prompt. Escaping neutralizes this by ensuring descriptions are always treated as text content.

## Alphabetical Ordering

Matched files are sorted alphabetically before output. This makes the prompt deterministic: the same set of files always produces the same XML, regardless of filesystem enumeration order or git internals. Deterministic output is useful for testing, debugging, and avoiding spurious diffs when comparing hook output across runs.

## Writing Effective Descriptions

Descriptions are the mechanism Claude uses to decide whether to read a doc. A good description acts as a **topic index entry** -- it tells Claude what the doc covers in enough detail to match against a task.

### Length

Aim for **15-20 words**. Shorter descriptions lack the specificity for Claude to match them to tasks. Longer descriptions waste tokens and blur the signal.

### What to Include

State the **topic** and **key details** that distinguish this doc from others:

- `Testing strategy and commands. Unit tests for helpers, integration tests for hook with git-aware and fallback discovery. CI matrix.`
- `Configuration reference. Environment variables for disabling plugin, custom glob patterns, glob syntax, and where to set them.`

The pattern is: **what it's about** (1-3 words) + **what's inside** (specific nouns that Claude can match against a task).

### What to Avoid

- **Vague summaries**: "Overview of the project" -- too generic to trigger a Read on any specific task.
- **Full sentences**: "This document describes how testing works in the project." -- wastes tokens on grammar. Use sentence fragments.
- **Implementation details**: Don't explain *how* something works in the description. That's what the doc content is for. The description only needs to signal *what topics* the doc covers.

### How Descriptions Interact with Instructions

The third instruction sentence -- "When a doc's description overlaps with the current task, use Read to load its full content" -- means Claude is pattern-matching task keywords against description keywords. Descriptions should contain the **same terminology** the user or Claude would use when working on that topic. If your doc covers environment variables, say "environment variables" in the description, not "runtime configuration knobs".
